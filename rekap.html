<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Data - Owner</title>
    <script>
        if (sessionStorage.getItem('userRole') !== 'owner') { window.location.href = "input.html"; }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .app-header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .header-nav a {
            text-decoration: none;
            color: #888;
            font-weight: 600;
            margin: 0 10px;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .header-nav a:hover,
        .header-nav a.active {
            background: #e3f2fd;
            color: #0d6efd;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table thead th {
            background: #f8f9fa;
            color: #444;
            padding: 15px;
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 2px solid #eee;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tbody td {
            background: white;
            padding: 12px 15px;
            font-size: 0.9rem;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .data-table tbody tr:hover td {
            background: #fafafa;
        }

        .badge-pill {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .bg-gradient-ps {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
        }

        .bg-gradient-fnb {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
        }

        .btn-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin: 0 2px;
        }

        .btn-edit {
            background: #fff3cd;
            color: #856404;
        }

        .btn-del {
            background: #f8d7da;
            color: #721c24;
        }

        /* Grand Total Card */
        .total-summary-card {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(44, 62, 80, 0.2);
        }

        /* Mobile Responsive Handling */
        .mobile-card {
            display: none;
        }

        .desktop-table {
            display: block;
        }

        @media (max-width: 768px) {
            .desktop-table {
                display: none;
            }

            .mobile-card {
                display: block;
                background: white;
                border-radius: 15px;
                margin-bottom: 15px;
                padding: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                border: 1px solid #f1f1f1;
            }

            .m-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }

            .m-label {
                color: #888;
                font-weight: 500;
                font-size: 0.8rem;
            }

            .m-val {
                font-weight: 700;
                color: #333;
            }

            .m-divider {
                border-bottom: 1px dashed #eee;
                margin: 10px 0;
            }

            .m-actions {
                text-align: right;
                margin-top: 10px;
            }

            .header-nav {
                display: none !important;
            }

            /* Hide text nav on mobile */
        }
    </style>
</head>

<body>

    <div class="app-header d-flex justify-content-between align-items-center px-3 shadow-sm sticky-top">
        <div class="d-flex align-items-center gap-2">
            <a href="input.html" class="btn btn-light rounded-circle shadow-sm" style="width: 40px; height: 40px;">â¬…</a>
            <h5 class="fw-bold m-0 text-dark">DATA LAPORAN</h5>
        </div>

        <div class="header-nav d-none d-md-block">
            <a href="input.html">Input</a>
            <a href="#" class="active">Laporan</a>
            <a href="manage_users.html">User Management</a>
        </div>

        <div>
            <span class="badge bg-primary rounded-pill">OWNER</span>
        </div>
    </div>

    <div class="container-fluid px-3 px-md-4">

        <!-- Header Controls -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h6 class="fw-bold m-0 text-muted">Data Laporan</h6>
                <a href="rekaparsip.html" class="btn btn-sm btn-outline-primary rounded-pill mt-1">ðŸ“‚ Lihat Arsip</a>
            </div>

            <!-- Tutupan Button (Owner Only) -->
            <button id="btnTutupan" class="btn btn-danger btn-sm shadow-sm rounded-pill px-3 fw-bold"
                onclick="tutupan()" style="display:none;">
                ðŸ”’ TUTUPAN BULANAN
            </button>
        </div>

        <!-- Grand Total Stats -->
        <div class="total-summary-card">
            <div class="row text-center">
                <div class="col-4 border-end border-light">
                    <small class="text-white-50 fw-bold">TOTAL PS</small>
                    <h5 class="fw-bold mb-0 mt-1" id="gt-ps">Rp 0</h5>
                </div>
                <div class="col-4 border-end border-light">
                    <small class="text-white-50 fw-bold">TOTAL FNB</small>
                    <h5 class="fw-bold mb-0 mt-1" id="gt-fnb">Rp 0</h5>
                </div>
                <div class="col-4">
                    <small class="text-warning fw-bold">GRAND TOTAL</small>
                    <h4 class="fw-bold mb-0 mt-1 text-warning" id="gt-all">Rp 0</h4>
                </div>
            </div>
        </div>

        <div id="loading-state" class="text-center p-5 text-muted">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="small fw-bold">Mengambil data dari server...</p>
        </div>

        <div id="data-container" style="display: none;">

            <!-- DESKTOP TABLE VIEW -->
            <div class="glass-card p-0 overflow-hidden desktop-table mb-4">
                <div class="table-responsive" style="max-height: 70vh;">
                    <table class="data-table text-center table-hover mb-0">
                        <thead>
                            <tr>
                                <th>AKSI</th>
                                <th>TANGGAL</th>
                                <th>USER</th>
                                <th class="text-primary bg-light border-start">TOTAL PS</th>
                                <th class="text-muted small">CASH</th>
                                <th class="text-muted small">QRIS</th>
                                <th class="text-success bg-light border-start">TOTAL FNB</th>
                                <th class="text-muted small">CASH</th>
                                <th class="text-muted small">QRIS</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyDesktop"></tbody>
                    </table>
                </div>
            </div>

            <!-- MOBILE CARD VIEW -->
            <div id="cardListMobile" class="pb-5"></div>

        </div>

    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyr4HaHcMknb_g9XmR-vZHbNCWSaIl1VokxtwVmmg1RuBeFWW1xQIM7_kM-sWXczCe1/exec';
        let globalRawData = [];

        const fmt = (v) => v ? Number(v).toLocaleString('id-ID') : '0';
        const formatDate = (d) => {
            if (!d) return '-';
            try {
                const date = new Date(d);
                if (isNaN(date.getTime())) return d;
                return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: '2-digit' });
            } catch (e) { return d; }
        };

        // Safe date for input value (YYYY-MM-DD)
        const safeDateValue = (d) => {
            try {
                const date = new Date(d);
                if (isNaN(date.getTime())) return '';
                return date.toISOString().split('T')[0];
            } catch (e) { return ''; }
        };

        function checkOwner() {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'owner') {
                document.getElementById('btnTutupan').style.display = 'block';
            }
        }

        function loadData() {
            const loadingState = document.getElementById('loading-state');
            const dataContainer = document.getElementById('data-container');

            checkOwner(); // Show tutupan button if owner

            loadingState.style.display = 'block';
            dataContainer.style.display = 'none';

            fetch(scriptURL)
                .then(res => res.json())
                .then(res => {
                    if (res.status === 'success') {
                        if (!Array.isArray(res.data)) throw new Error('Format data invalid');
                        globalRawData = res.data;
                        renderData(res.data); // Filter and display
                    } else {
                        throw new Error(res.message || 'API Error');
                    }
                })
                .catch(err => {
                    console.error(err);
                    loadingState.innerHTML = `
                    <p class="text-danger fw-bold mb-1">Gagal memuat data</p>
                    <small class="text-muted text-break" style="font-size:0.7rem;">${err.message}</small>
                    <div class="mt-3"><button onclick="location.reload()" class="btn btn-sm btn-outline-secondary">Coba Lagi</button></div>
                `;
                });
        }

        function renderData(rawData) {
            const loadingState = document.getElementById('loading-state');
            const dataContainer = document.getElementById('data-container');

            loadingState.style.display = 'none';
            dataContainer.style.display = 'block';

            // Filter Data (Basic validation)
            const cleanData = rawData.filter(item => {
                if (!item || !item.values || !item.values[0]) return false;
                const dateVal = item.values[0];
                if (typeof dateVal === 'string' && dateVal.toLowerCase().includes('tanggal')) return false; // Skip Header
                return true; // Allow viewing all data for now, since archive is manual
            });

            // Sort Descending
            cleanData.sort((a, b) => {
                try { return new Date(b.values[0]) - new Date(a.values[0]); } catch (e) { return 0; }
            });

            let totalPS = 0;
            let totalFNB = 0;
            let htmlDesktop = '';
            let htmlMobile = '';

            cleanData.forEach(item => {
                const row = item.values;
                const idx = item.excel_row_index;

                totalPS += Number(row[1]) || 0;
                totalFNB += Number(row[4]) || 0;

                const safeDate = safeDateValue(row[0]);
                const rowData = encodeURIComponent(JSON.stringify({
                    idx, date: safeDate,
                    ps_t: row[1], ps_c: row[2], ps_q: row[3],
                    fnb_t: row[4], fnb_c: row[5], fnb_q: row[6]
                }));

                // Generate HTML (Desktop & Mobile)
                htmlDesktop += `
                <tr>
                    <td>
                        <button class="btn-icon btn-edit" onclick="editRow('${rowData}')">âœŽ</button>
                        <button class="btn-icon btn-del" onclick="deleteRow(${idx})">ðŸ—‘</button>
                    </td>
                    <td class="fw-bold text-dark">${formatDate(row[0])}</td>
                    <td><span class="badge bg-light text-dark border">${row[7] || '-'}</span></td>
                    <td class="fw-bold text-primary border-start">${fmt(row[1])}</td>
                    <td class="text-muted small">${fmt(row[2])}</td>
                    <td class="text-muted small">${fmt(row[3])}</td>
                    <td class="fw-bold text-success border-start">${fmt(row[4])}</td>
                    <td class="text-muted small">${fmt(row[5])}</td>
                    <td class="text-muted small">${fmt(row[6])}</td>
                </tr>`;

                htmlMobile += `
                <div class="mobile-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-bold text-dark" style="font-size: 1.1rem;">${formatDate(row[0])}</div>
                        <span class="badge bg-light text-secondary border">${row[7] || '-'}</span>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 rounded bg-light border-start border-4 border-primary">
                                <div class="m-label text-primary">RENTAL PS</div>
                                <div class="m-val text-primary">Rp ${fmt(row[1])}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded bg-light border-start border-4 border-success">
                                <div class="m-label text-success">FNB / MAKAN</div>
                                <div class="m-val text-success">Rp ${fmt(row[4])}</div>
                            </div>
                        </div>
                    </div>
                    <div class="m-actions border-top pt-2 mt-2">
                            <button class="btn btn-sm btn-outline-warning py-1 px-3 fw-bold rounded-pill" onclick="editRow('${rowData}')">Edit</button>
                            <button class="btn btn-sm btn-outline-danger py-1 px-3 fw-bold rounded-pill" onclick="deleteRow(${idx})">Hapus</button>
                    </div>
                </div>`;
            });

            if (cleanData.length === 0) {
                const noDataMsg = `<tr><td colspan="9" class="p-5 text-muted">Belum ada data.</td></tr>`;
                htmlDesktop = noDataMsg;
                htmlMobile = `<div class="text-center p-5 text-muted bg-light rounded-3 mt-3">Belum ada data</div>`;
            }

            document.getElementById('tableBodyDesktop').innerHTML = htmlDesktop;
            document.getElementById('cardListMobile').innerHTML = htmlMobile;
            document.getElementById('gt-ps').innerText = 'Rp ' + fmt(totalPS);
            document.getElementById('gt-fnb').innerText = 'Rp ' + fmt(totalFNB);
            document.getElementById('gt-all').innerText = 'Rp ' + fmt(totalPS + totalFNB);
        }

        async function tutupan() {
            if (!globalRawData || globalRawData.length === 0) {
                Swal.fire('Data Kosong', 'Tidak ada data untuk diarsip.', 'info');
                return;
            }

            const { value: arsipName } = await Swal.fire({
                title: 'Tutupan Bulanan',
                input: 'text',
                inputLabel: 'Masukkan Nama Arsip / Periode',
                inputPlaceholder: 'Contoh: Februari 2026',
                showCancelButton: true,
                confirmButtonText: 'Simpan & Bersihkan',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#d33',
                inputValidator: (value) => {
                    if (!value) return 'Nama arsip tidak boleh kosong!';
                }
            });

            if (arsipName) {
                Swal.fire({
                    title: 'Memproses Tutupan...',
                    html: 'Menyimpan arsip dan menghapus data lama.<br><b>JANGAN TUTUP HALAMAN INI!</b>',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 1. Save to Archive (Local JSON)
                try {
                    const saveRes = await fetch('api/archive.php?action=save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: arsipName, data: globalRawData })
                    });
                    const saveJson = await saveRes.json();

                    if (saveJson.status !== 'success') throw new Error(saveJson.message);

                    // 2. Delete All Rows from Google Sheet (Reverse Loop to prevent index shift issues)
                    // Filter only valid rows that have excel_row_index
                    const validRows = globalRawData.filter(r => r.excel_row_index).sort((a, b) => b.excel_row_index - a.excel_row_index);

                    // Using Promise.all meant parallelism which might hit API limits. 
                    // Sequential is safer for GAS.
                    for (const row of validRows) {
                        await fetch(scriptURL + `?action=delete&row=${row.excel_row_index}`, { method: 'POST', mode: 'no-cors' });
                        // Small delay to be polite to the server
                        await new Promise(r => setTimeout(r, 500));
                    }

                    Swal.fire('Berhasil!', 'Data telah diarsip dan halaman dibersihkan.', 'success')
                        .then(() => location.reload());

                } catch (err) {
                    console.error(err);
                    Swal.fire('Gagal!', 'Terjadi kesalahan: ' + err.message, 'error');
                }
            }
        }

        window.deleteRow = (rowIndex) => {
            Swal.fire({
                title: 'Hapus data?', text: "Data akan hilang permanen!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Hapus'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    fetch(scriptURL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'delete', row_index: rowIndex })
                    }).then(() => {
                        Swal.fire('Terhapus!', '', 'success');
                        loadData();
                    });
                }
            });
        };

        window.editRow = (data_str) => {
            const data = JSON.parse(decodeURIComponent(data_str));

            Swal.fire({
                title: 'Edit Transaksi',
                width: '600px',
                html: `
                <style>
                    .swal-group { text-align: left; margin-bottom: 15px; }
                    .swal-group label { font-size: 0.8rem; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
                    .swal-row { display: flex; gap: 10px; }
                    .swal-col { flex: 1; }
                    .swal-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 0.95rem; }
                    .swal-input:focus { border-color: #4facfe; outline: none; }
                    .header-sect { font-weight: 800; font-size: 0.9rem; margin: 15px 0 5px; padding-bottom: 5px; border-bottom: 2px solid #eee; text-transform: uppercase; }
                </style>
                
                <div class="swal-group">
                    <label>Tanggal Transaksi</label>
                    <input type="date" id="e_date" class="swal-input" value="${data.date}">
                </div>

                <div class="header-sect text-primary">Rental PS</div>
                <div class="swal-row">
                    <div class="swal-col"><label>CASH</label><input type="number" id="e_ps_c" class="swal-input ps-calc" value="${data.ps_c}"></div>
                    <div class="swal-col"><label>QRIS</label><input type="number" id="e_ps_q" class="swal-input ps-calc" value="${data.ps_q}"></div>
                </div>
                <div class="swal-group mt-2">
                    <label class="text-primary">TOTAL PS (Auto)</label>
                    <input type="number" id="e_ps_t" class="swal-input fw-bold" value="${data.ps_t}" readonly style="background:#f0f7ff; border-color:#cce5ff;">
                </div>

                <div class="header-sect text-success">FNB / Makanan</div>
                <div class="swal-row">
                    <div class="swal-col"><label>CASH</label><input type="number" id="e_fnb_c" class="swal-input fnb-calc" value="${data.fnb_c}"></div>
                    <div class="swal-col"><label>QRIS</label><input type="number" id="e_fnb_q" class="swal-input fnb-calc" value="${data.fnb_q}"></div>
                </div>
                <div class="swal-group mt-2">
                    <label class="text-success">TOTAL FNB (Auto)</label>
                    <input type="number" id="e_fnb_t" class="swal-input fw-bold" value="${data.fnb_t}" readonly style="background:#f0fff4; border-color:#c3e6cb;">
                </div>
            `,
                showCancelButton: true,
                confirmButtonText: 'Simpan Perubahan',
                confirmButtonColor: '#2c3e50',
                didOpen: () => {
                    // Auto calc logic inside modal
                    const calcPS = () => {
                        const c = Number(document.getElementById('e_ps_c').value) || 0;
                        const q = Number(document.getElementById('e_ps_q').value) || 0;
                        document.getElementById('e_ps_t').value = c + q;
                    };
                    const calcFNB = () => {
                        const c = Number(document.getElementById('e_fnb_c').value) || 0;
                        const q = Number(document.getElementById('e_fnb_q').value) || 0;
                        document.getElementById('e_fnb_t').value = c + q;
                    };
                    document.querySelectorAll('.ps-calc').forEach(el => el.addEventListener('input', calcPS));
                    document.querySelectorAll('.fnb-calc').forEach(el => el.addEventListener('input', calcFNB));
                },
                preConfirm: () => {
                    return {
                        action: 'update',
                        row_index: data.idx,
                        tanggal: document.getElementById('e_date').value,
                        ps_total: document.getElementById('e_ps_t').value,
                        ps_cash: document.getElementById('e_ps_c').value,
                        ps_qris: document.getElementById('e_ps_q').value,
                        fnb_total: document.getElementById('e_fnb_t').value,
                        fnb_cash: document.getElementById('e_fnb_c').value,
                        fnb_qris: document.getElementById('e_fnb_q').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });

                    fetch(scriptURL, {
                        method: 'POST',
                        body: JSON.stringify(result.value)
                    })
                        .then(res => res.json())
                        .then(res => {
                            if (res.status === 'success') {
                                Swal.fire('Berhasil!', 'Data telah diperbarui.', 'success');
                                loadData();
                            } else {
                                throw new Error(res.message);
                            }
                        })
                        .catch(err => Swal.fire('Error', 'Gagal update: ' + err, 'error'));
                }
            });
        }

        loadData();
    </script>
</body>

</html>