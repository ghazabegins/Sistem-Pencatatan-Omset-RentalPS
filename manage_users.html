<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola User - UNIX</title>
    <script>
        if (sessionStorage.getItem('userRole') !== 'owner') { window.location.href = "input.html"; }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .app-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .user-card-desktop {
            display: table-row;
        }

        .user-card-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .table-responsive {
                border: none !important;
            }

            .user-card-desktop {
                display: none;
            }

            .user-card-mobile {
                display: flex;
                flex-direction: column;
                background: white;
                border-radius: 15px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                border: 1px solid #f8f9fa;
            }

            .uc-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .uc-actions {
                display: flex;
                gap: 10px;
                margin-top: 10px;
                border-top: 1px dashed #eee;
                padding-top: 10px;
            }

            .uc-actions button {
                flex: 1;
            }

            .glass-card {
                background: transparent !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }

            /* Hide Thead on mobile */
            thead {
                display: none;
            }
        }
    </style>
</head>

<body>

    <div class="app-header d-flex justify-content-between align-items-center shadow-sm">
        <div class="d-flex align-items-center gap-2">
            <a href="input.html" class="btn btn-light rounded-circle shadow-sm"
                style="width: 35px; height: 35px; display:flex; align-items:center; justify-content:center;">â¬…</a>
            <h6 class="fw-bold m-0 text-uppercase">Kelola User</h6>
        </div>
        <button onclick="openAddModal()"
            class="btn btn-primary-gradient rounded-pill px-3 py-1 btn-sm fw-bold shadow-sm">+ User</button>
    </div>

    <div class="container pb-5">

        <div class="glass-card">
            <table class="table table-hover align-middle mb-0" style="background: transparent;">
                <thead class="table-light">
                    <tr>
                        <th style="border-radius: 10px 0 0 10px;">USERNAME</th>
                        <th>ROLE</th>
                        <th class="text-end" style="border-radius: 0 10px 10px 0;">AKSI</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Data loaded via JS -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = 'api/auth.php';
        const activeUser = sessionStorage.getItem('activeUser');

        function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Loading...</td></tr>';

            fetch(API_URL + '?action=get_users')
                .then(res => res.json())
                .then(res => {
                    if (res.status === 'success') {
                        tbody.innerHTML = '';
                        res.data.forEach(user => {
                            let deleteBtn = '';
                            // Do not allow deleting self
                            if (user.username !== activeUser) {
                                deleteBtn = `<button onclick="deleteUser(${user.id})" class="btn btn-sm btn-outline-danger px-3 rounded-pill fw-bold">Hapus</button>`;
                            }

                            // Determine badges
                            const roleBadge = user.role === 'owner'
                                ? '<span class="badge bg-primary rounded-pill">OWNER</span>'
                                : '<span class="badge bg-success rounded-pill">STAFF</span>';

                            const editBtn = `<button onclick="editUser('${user.id}', '${user.username}', '${user.role}')" class="btn btn-sm btn-outline-primary px-3 me-1 rounded-pill fw-bold">Edit</button>`;

                            // --- DESKTOP ROW ---
                            const desktopRow = `
                            <tr class="user-card-desktop">
                                <td class="fw-bold ps-3">${user.username}</td>
                                <td>${roleBadge}</td>
                                <td class="text-end pe-3">
                                    ${editBtn}
                                    ${deleteBtn}
                                </td>
                            </tr>
                        `;

                            // --- MOBILE CARD ---
                            const mobileCard = `
                            <tr class="d-md-none border-0 bg-transparent">
                                <td colspan="3" class="p-0 border-0">
                                    <div class="user-card-mobile p-3 bg-white rounded-3 mb-3 shadow-sm">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-muted small">Username</div>
                                                <div class="fw-bold fs-5">${user.username}</div>
                                            </div>
                                            ${roleBadge}
                                        </div>
                                        <div class="uc-actions d-grid gap-2 d-md-block mt-3 pt-2 border-top">
                                            ${editBtn}
                                            ${deleteBtn}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;

                            tbody.innerHTML += desktopRow + mobileCard;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data</td></tr>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error Server</td></tr>';
                });
        }

        function openAddModal() {
            Swal.fire({
                title: 'Tambah User Baru',
                html: `
                <div class="mb-3 text-start">
                    <label class="small fw-bold text-muted">Username</label>
                    <input id="new-username" class="form-control" placeholder="Contoh: staff1">
                </div>
                <div class="mb-3 text-start">
                    <label class="small fw-bold text-muted">Password</label>
                    <input id="new-password" type="password" class="form-control" placeholder="*****">
                </div>
                <div class="mb-3 text-start">
                    <label class="small fw-bold text-muted">Role</label>
                    <select id="new-role" class="form-control">
                        <option value="staff">Staff</option>
                        <option value="owner">Owner</option>
                    </select>
                </div>
            `,
                confirmButtonText: 'Simpan',
                confirmButtonColor: '#4facfe',
                showCancelButton: true,
                preConfirm: () => {
                    const u = document.getElementById('new-username').value;
                    const p = document.getElementById('new-password').value;
                    if (!u || !p) { Swal.showValidationMessage('Data harus lengkap'); }
                    return { username: u, password: p, role: document.getElementById('new-role').value }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(API_URL + '?action=add_user', {
                        method: 'POST', body: JSON.stringify(result.value)
                    }).then(res => res.json()).then(res => {
                        if (res.status === 'success') {
                            Swal.fire('Berhasil', 'User ditambahkan', 'success');
                            loadUsers();
                        } else {
                            Swal.fire('Gagal', res.message, 'error');
                        }
                    });
                }
            });
        }

        function editUser(id, currentName, currentRole) {
            Swal.fire({
                title: 'Edit User',
                html: `
                <div class="mb-3 text-start">
                    <label class="small fw-bold text-muted">Username</label>
                    <input id="edit-username" class="form-control" value="${currentName}">
                </div>
                <div class="mb-3 text-start">
                    <label class="small fw-bold text-muted">Password Baru</label>
                    <input id="edit-password" type="password" class="form-control" placeholder="(Opsional)">
                </div>
                <div class="mb-3 text-start">
                    <label class="small fw-bold text-muted">Role</label>
                    <select id="edit-role" class="form-control">
                        <option value="staff" ${currentRole === 'staff' ? 'selected' : ''}>Staff</option>
                        <option value="owner" ${currentRole === 'owner' ? 'selected' : ''}>Owner</option>
                    </select>
                </div>
            `,
                confirmButtonText: 'Update',
                confirmButtonColor: '#4facfe',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        id: id,
                        username: document.getElementById('edit-username').value,
                        password: document.getElementById('edit-password').value,
                        role: document.getElementById('edit-role').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(API_URL + '?action=edit_user', {
                        method: 'POST', body: JSON.stringify(result.value)
                    }).then(res => res.json()).then(res => {
                        if (res.status === 'success') {
                            Swal.fire('Berhasil', 'User diupdate', 'success');
                            loadUsers();
                        } else {
                            Swal.fire('Gagal', res.message, 'error');
                        }
                    });
                }
            });
        }

        function deleteUser(id) {
            Swal.fire({
                title: 'Hapus User?', text: "Hati-hati, tidak bisa dikembalikan.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(API_URL + '?action=delete_user', {
                        method: 'POST', body: JSON.stringify({ id: id })
                    }).then(res => res.json()).then(res => {
                        if (res.status === 'success') {
                            Swal.fire('Terhapus', '', 'success');
                            loadUsers();
                        } else {
                            Swal.fire('Gagal', res.message, 'error');
                        }
                    });
                }
            });
        }

        loadUsers();
    </script>

</body>

</html>